<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Hello World</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.2/react-with-addons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/15.6.2/react-dom.js"></script>
    <!--
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script> 
    -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-virtualized/9.14.1/react-virtualized.js"></script>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        class Counter extends React.Component {  
            constructor (props) {
                super(props)
                this.state = {
                    clicks: 0
                }
                this.handleButtonClick = this.handleButtonClick.bind(this)
            }

            handleButtonClick() {
                this.setState({clicks: this.state.clicks + 1})
            }

            render () {
                return <div> 
                    <ClicksCount count={this.state.clicks} />
                    <CounterButton onClick={this.handleButtonClick}>Click me!</CounterButton>
                </div>;
            }
        };

        class ClicksCount extends React.Component {
            render () {
                return <span>{this.props.count} clicks</span>;
            }
        };

        class CounterButton extends React.Component {
            render() {
                return <button onClick={this.props.onClick}>{this.props.children}</button>;
            }
        };

        const generateId = (() => {
            let i = 0
            return () => i++
        })()

        const createItem = () => {
            let id = generateId()
            return {name: `Item #${id}`, id: id}
        }
        const initialItems = Array(500).fill().map(createItem)
        const { List } = ReactVirtualized
        
        class BigList extends React.Component {
            constructor(props) {
                super(props)
                this.state = {
                    items: initialItems,
                    virtualized: false
                }

                this.addItem = this.addItem.bind(this)
                this.removeItem = this.removeItem.bind(this)
            }

            // componentWillMount () {
            //     React.addons.Perf.start();
            // }
            
            // componentDidMount () {
            //     React.addons.Perf.stop();
            //     const measurements = React.addons.Perf.getLastMeasurements();
            //     React.addons.Perf.printInclusive(measurements);      
            // }

            // componentWillUpdate () {
            //     React.addons.Perf.start();
            // }

            // componentDidUpdate () {
            //     React.addons.Perf.stop();
            //     const measurements = React.addons.Perf.getLastMeasurements();
            //     React.addons.Perf.printInclusive(measurements);
            // }
            toggleVirtualized = () => {
                this.setState(function (state) {
                    return {
                        virtualized: !state.virtualized
                    }
                })
            } 
            addItem = () => {
                this.setState(function (state) {
                    // const items = this.state.items

                    // items.push(createItem())

                    // return {
                    //     items
                    // }
                    return {
                        items: [...state.items, createItem()]
                    }
                })
            }

            removeItem = (id) => {
                this.setState(function (state) {
                    // const items = state.items
                    // const i = items.findIndex((item) => {
                    //     return item.id === id
                    // })
                    // if (i > -1) {
                    //     items.splice(i, 1)
                    //     return { items }
                    // }
                    return {
                        items: state.items.filter(item => item.id !== id)
                    }
                })
            }

            renderItem = (i, key, style) => {
                const item = this.state.items[i]
                return <ListItem item={item} key={key} style={style} onRemoveClick={this.removeItem}/>
            }

            rowRenderer = ({index, key, style}) => {
                console.log(index, key, style)
                return this.renderItem(index, key, style)
            }

            renderList() {
                return <ul>
                    {this.state.items.map((item, index) => this.renderItem(index, item.id))}
                </ul>
            }

            renderVirtualizedList() {
                return <List 
                    height={200}
                    width={500}
                    rowHeight={20}
                    rowCount={this.state.items.length}
                    rowRenderer={this.rowRenderer}
                />
            }

            render() {
                return <div>
                    <label><input type="checkbox" checked={this.state.virtualized} onChange={this.toggleVirtualized}/> Virtualized</label>
                    <button onClick={this.addItem}>Add item</button>
                    {!this.state.virtualized ? this.renderList() : this.renderVirtualizedList()}
                </div>
            }
        }

        // Add item in BigList
        // ListItem as Component 241ms
        // ListItem as PureComponent 94ms
        // With Virtualized 63ms

        // Remove item in BigList
        // ListItem as Component 226ms
        // ListItem as PureComponent 106ms
        // With Virtualized 84ms
        class ListItem extends React.PureComponent {
            handleRemoveClick = () => {
                this.props.onRemoveClick(this.props.item.id)
            }

            render () {
                const { item, style } = this.props
                return <li style={style}>
                    <span>{item.name}</span>
                    <button onClick={this.handleRemoveClick}>Del</button>
                </li>
            }
        }

        ReactDOM.render(
            <BigList />,
            document.getElementById('root')
        );
    </script>
    <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      To set up a production-ready React build environment, follow these instructions:
      * https://reactjs.org/docs/add-react-to-a-new-app.html
      * https://reactjs.org/docs/add-react-to-an-existing-app.html

      You can also use React without JSX, in which case you can remove Babel:
      * https://reactjs.org/docs/react-without-jsx.html
      * https://reactjs.org/docs/cdn-links.html
    -->
</body>

</html>